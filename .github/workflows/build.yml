name: CI Build & Audit

on:
  pull_request:
    branches: [ main ]

jobs:
  matrix-setup:
    name: Resolve Build Matrix
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.matrix.outputs.versions }}
      variants: ${{ steps.matrix.outputs.variants }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract matrix from versions.json
        id: matrix
        run: |
          VERSIONS=$(jq -c '[keys[] | ltrimstr("ubi")]' versions.json)
          VARIANTS=$(jq -c '[to_entries[].value | to_entries[] | select(.value | type == "object" and has("base")) | .key] | unique' versions.json)
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
          echo "variants=$VARIANTS" >> $GITHUB_OUTPUT
          echo "Resolved versions: $VERSIONS"
          echo "Resolved variants: $VARIANTS"

  build-and-sign:
    name: Build UBI Variant
    needs: matrix-setup
    runs-on: ubuntu-latest
    environment: Build-Actor
    permissions:
      contents: read
      packages: write
      id-token: write # Required if you eventually use keyless signing

    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.matrix-setup.outputs.variants) }}
        version: ${{ fromJSON(needs.matrix-setup.outputs.versions) }}
        arch: [amd64, arm64]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Install Syft & Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Buildah
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Upstream Metadata
        id: metadata
        run: |
          # Querying: .ubi9.standard.base and .ubi9.standard.digest
          KEY_VER="ubi${{ matrix.version }}"
          VAR="${{ matrix.variant }}"
          
          BASE=$(jq -r ".$KEY_VER.$VAR.base" versions.json)
          DIGEST=$(jq -r ".$KEY_VER.$VAR.digest" versions.json)
          
          # Safety check: fail if jq returns null (variant not defined in JSON)
          if [[ "$BASE" == "null" ]]; then
            echo "Error: Variant $VAR not found for $KEY_VER in versions.json"
            exit 1
          fi

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Build Image with Buildah
        id: build
        env:
          REGISTRY: ghcr.io/${{ github.repository }}/development
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          IMAGE_NAME="${REGISTRY}/ubi${{ matrix.version }}-${{ matrix.variant }}"
          TAG="pr-${PR_NUM}-${{ matrix.arch }}"
          
          echo "Building Development Image: $IMAGE_NAME:$TAG"
          
          # 1. Build the image (added IMAGE_VERSION to silence warning)
          buildah bud \
            --platform linux/${{ matrix.arch }} \
            --build-arg UPSTREAM_BASE="${{ steps.metadata.outputs.base }}" \
            --build-arg UPSTREAM_DIGEST="${{ steps.metadata.outputs.digest }}" \
            --build-arg IMAGE_VERSION="${{ github.ref_name }}" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg TARGETARCH="${{ matrix.arch }}" \
            -t "$IMAGE_NAME:$TAG" \
            -f Containerfiles/ubi${{ matrix.version }}-${{ matrix.variant }}.Containerfile .
          
          # 2. Push the image
          buildah push "$IMAGE_NAME:$TAG"

          # 3. Export to local OCI directory for Syft/Grype scanning
          buildah push "$IMAGE_NAME:$TAG" oci:./oci-image
          
          # 4. Capture the hex ID
          RAW_DIGEST=$(buildah inspect --format '{{.FromImageID}}' "$IMAGE_NAME:$TAG")
          
          # Ensure it has the sha256 prefix for OCI tools
          FULL_DIGEST="sha256:${RAW_DIGEST}"
          
          echo "image_uri=$IMAGE_NAME@$FULL_DIGEST" >> $GITHUB_OUTPUT
          echo "digest=$FULL_DIGEST" >> $GITHUB_OUTPUT

      - name: Generate and Sign Artifacts
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          LOCAL_IMAGE: "oci-dir:./oci-image"
        run: |
          echo "üì¶ Generating SBOM (Syft) from local storage..."
          syft "${{ env.LOCAL_IMAGE }}" -o spdx-json=sbom.json
          
          echo "üîç Scanning for vulnerabilities (Grype) from local storage..."
          grype "${{ env.LOCAL_IMAGE }}" -o json > cve-report.json
          
          echo "üñãÔ∏è Signing artifacts with Build-Actor sovereign key..."
          # Note: We still sign using the FULL_DIGEST to ensure the signature 
          # is bound to the immutable content-hash pushed to GHCR.
          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature sbom.json.sig sbom.json

          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature cve-report.json.sig cve-report.json

      - name: Upload Evidence Bundle
        uses: actions/upload-artifact@v4
        with:
          name: evidence-ubi${{ matrix.version }}-${{ matrix.variant }}-${{ matrix.arch }}
          path: |
            sbom.json
            sbom.json.sig
            cve-report.json
            cve-report.json.sig