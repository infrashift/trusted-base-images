name: CI Build & Audit

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'Containerfiles/**'
      - 'versions.json'

jobs:
  matrix-setup:
    name: Resolve Build Matrix
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.matrix.outputs.versions }}
      variants: ${{ steps.matrix.outputs.variants }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Extract matrix from versions.json
        id: matrix
        run: |
          VERSIONS=$(jq -c '[keys[] | ltrimstr("ubi")]' versions.json)
          VARIANTS=$(jq -c '[to_entries[].value | to_entries[] | select(.value | type == "object" and has("base")) | .key] | unique' versions.json)
          echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
          echo "variants=$VARIANTS" >> $GITHUB_OUTPUT
          echo "Resolved versions: $VERSIONS"
          echo "Resolved variants: $VARIANTS"

  build-and-sign:
    name: Build UBI Variant
    needs: matrix-setup
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    environment: Build-Actor
    permissions:
      contents: read
      packages: write
      id-token: write # Required if you eventually use keyless signing

    strategy:
      fail-fast: false
      matrix:
        variant: ${{ fromJSON(needs.matrix-setup.outputs.variants) }}
        version: ${{ fromJSON(needs.matrix-setup.outputs.versions) }}
        arch: [amd64, arm64]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Install Syft & Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install Buildah
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Upstream Metadata
        id: metadata
        run: |
          # Querying: .ubi9.standard.base and .ubi9.standard.digest
          KEY_VER="ubi${{ matrix.version }}"
          VAR="${{ matrix.variant }}"
          
          BASE=$(jq -r ".$KEY_VER.$VAR.base" versions.json)
          DIGEST=$(jq -r ".$KEY_VER.$VAR.digest" versions.json)
          
          # Safety check: fail if jq returns null (variant not defined in JSON)
          if [[ "$BASE" == "null" ]]; then
            echo "Error: Variant $VAR not found for $KEY_VER in versions.json"
            exit 1
          fi

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Build Image with Buildah
        id: build
        env:
          REGISTRY: ghcr.io/${{ github.repository }}/development
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          IMAGE_NAME="${REGISTRY}/ubi${{ matrix.version }}-${{ matrix.variant }}"
          TAG="pr-${PR_NUM}-${{ matrix.arch }}"
          
          echo "Building Development Image: $IMAGE_NAME:$TAG"
          
          # 1. Build the image (added IMAGE_VERSION to silence warning)
          buildah bud \
            --platform linux/${{ matrix.arch }} \
            --build-arg UPSTREAM_BASE="${{ steps.metadata.outputs.base }}" \
            --build-arg UPSTREAM_DIGEST="${{ steps.metadata.outputs.digest }}" \
            --build-arg IMAGE_VERSION="${{ github.ref_name }}" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg TARGETARCH="${{ matrix.arch }}" \
            -t "$IMAGE_NAME:$TAG" \
            -f Containerfiles/ubi${{ matrix.version }}-${{ matrix.variant }}.Containerfile .
          
          # 2. Push the image and capture the pushed manifest digest
          buildah push --digestfile ./pushed-digest.txt "$IMAGE_NAME:$TAG"
          PUSHED_DIGEST=$(cat ./pushed-digest.txt)
          IMAGE_URI="$IMAGE_NAME@$PUSHED_DIGEST"

          # 3. Export to local OCI directory for Syft/Grype scanning
          buildah push "$IMAGE_NAME:$TAG" oci:./oci-image

          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "digest=$PUSHED_DIGEST" >> $GITHUB_OUTPUT

      - name: Generate Evidence Artifacts
        env:
          LOCAL_IMAGE: "oci-dir:./oci-image"
        run: |
          echo "Generating SBOM (Syft) from local storage..."
          syft "${{ env.LOCAL_IMAGE }}" -o spdx-json=sbom.json

          echo "Scanning for vulnerabilities (Grype) from local storage..."
          grype "${{ env.LOCAL_IMAGE }}" -o json > cve-report.json

          echo "Fetching GitHub Actions OIDC token..."
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sigstore" | jq -r '.value')

          echo "Capturing build tool versions..."
          BUILDAH_VERSION=$(buildah --version | awk '{print $3}')
          COSIGN_VERSION=$(cosign version --json | jq -r '.gitVersion')
          SYFT_VERSION=$(syft --version | awk '{print $2}')
          GRYPE_VERSION=$(grype --version | awk '{print $2}')

          echo "Generating SLSA v1.0 build provenance..."
          jq -n \
            --arg buildType "https://github.com/${{ github.repository }}/build/v1" \
            --arg sourceUri "git+https://github.com/${{ github.repository }}@${{ github.ref }}" \
            --arg sourceDigest "${{ github.sha }}" \
            --arg variant "${{ matrix.variant }}" \
            --arg version "ubi${{ matrix.version }}" \
            --arg arch "${{ matrix.arch }}" \
            --arg containerfile "Containerfiles/ubi${{ matrix.version }}-${{ matrix.variant }}.Containerfile" \
            --arg platform "linux/${{ matrix.arch }}" \
            --arg buildahVersion "$BUILDAH_VERSION" \
            --arg cosignVersion "$COSIGN_VERSION" \
            --arg syftVersion "$SYFT_VERSION" \
            --arg grypeVersion "$GRYPE_VERSION" \
            --arg upstreamBase "${{ steps.metadata.outputs.base }}" \
            --arg upstreamDigest "${{ steps.metadata.outputs.digest }}" \
            --arg builderId "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg invocationId "${{ github.run_id }}/${{ github.run_attempt }}" \
            --arg startedOn "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --arg oidcToken "$OIDC_TOKEN" \
            --arg imageUri "${{ steps.build.outputs.image_uri }}" \
            --arg imageDigest "${{ steps.build.outputs.digest }}" \
            '{
              "buildDefinition": {
                "buildType": $buildType,
                "externalParameters": {
                  "source": {
                    "uri": $sourceUri,
                    "digest": { "sha1": $sourceDigest }
                  },
                  "variant": $variant,
                  "version": $version,
                  "arch": $arch
                },
                "internalParameters": {
                  "containerfile": $containerfile,
                  "platform": $platform,
                  "oidcToken": $oidcToken,
                  "output": {
                    "uri": $imageUri,
                    "digest": { "sha256": ($imageDigest | ltrimstr("sha256:")) }
                  }
                },
                "resolvedDependencies": [
                  {
                    "uri": $upstreamBase,
                    "digest": { "sha256": ($upstreamDigest | ltrimstr("sha256:")) }
                  }
                ]
              },
              "runDetails": {
                "builder": {
                  "id": $builderId,
                  "version": {
                    "buildah": $buildahVersion,
                    "cosign": $cosignVersion,
                    "syft": $syftVersion,
                    "grype": $grypeVersion
                  }
                },
                "metadata": {
                  "invocationId": $invocationId,
                  "startedOn": $startedOn
                }
              }
            }' > provenance.json

      - name: Sign Evidence Blobs
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          echo "Signing artifacts with Build-Actor sovereign key..."
          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature sbom.json.sig sbom.json

          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature cve-report.json.sig cve-report.json

          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature provenance.json.sig provenance.json

      - name: Attach Attestations to GHCR Image
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          IMAGE_URI: ${{ steps.build.outputs.image_uri }}
        run: |
          echo "Attaching SBOM attestation..."
          cosign attest --yes --replace --tlog-upload=false \
            --key env://COSIGN_PRIVATE_KEY \
            --type spdxjson --predicate sbom.json "$IMAGE_URI"

          echo "Attaching CVE report attestation..."
          cosign attest --yes --replace --tlog-upload=false \
            --key env://COSIGN_PRIVATE_KEY \
            --type vuln --predicate cve-report.json "$IMAGE_URI"

          echo "Attaching SLSA provenance attestation..."
          cosign attest --yes --replace --tlog-upload=false \
            --key env://COSIGN_PRIVATE_KEY \
            --type slsaprovenance1 --predicate provenance.json "$IMAGE_URI"

      - name: Generate Evidence Checksums
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          sha256sum sbom.json sbom.json.sig cve-report.json cve-report.json.sig provenance.json provenance.json.sig > checksums.sha256
          cosign sign-blob --tlog-upload=false --key env://COSIGN_PRIVATE_KEY \
            --output-signature checksums.sha256.sig checksums.sha256

      - name: Upload Evidence Bundle
        uses: actions/upload-artifact@v4
        with:
          name: evidence-ubi${{ matrix.version }}-${{ matrix.variant }}-${{ matrix.arch }}
          path: |
            sbom.json
            sbom.json.sig
            cve-report.json
            cve-report.json.sig
            provenance.json
            provenance.json.sig
            checksums.sha256
            checksums.sha256.sig